name: Build and Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup MSBuild (Visual Studio 2022)
        uses: microsoft/setup-msbuild@v1
        with:
          vs-version: '17.0'

      - name: Build detours (Release | x64)
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Professional\Common7\Tools\VsDevCmd.bat" -arch=amd64
          msbuild "3rdparty/detours/vc/Detours.sln" /m /p:Configuration=ReleaseMD /p:Platform=x64
        shell: cmd

      - name: Build detours (Release | x86)
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Professional\Common7\Tools\VsDevCmd.bat"
          msbuild "3rdparty/detours/vc/Detours.sln" /m /p:Configuration=ReleaseMD /p:Platform=x86
        shell: cmd

      - name: Build solution (Release | x64)
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Professional\Common7\Tools\VsDevCmd.bat" -arch=amd64
          msbuild "myinput.sln" /m /p:Configuration=Release /p:Platform=x64
        shell: cmd

      - name: Build solution (Release | x86)
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Professional\Common7\Tools\VsDevCmd.bat"
          msbuild "myinput.sln" /m /p:Configuration=Release /p:Platform=x86
        shell: cmd

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-build
          path: |
            myinput.exe
            */myinput*.dll
            */myinput*.exe
            Logs/_default.log
            Configs/_default.ini
            !*/myinput_test.exe

  prerelease:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: release-build
          path: ./artifact

      - name: Create release with gh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="v$(date +%Y%m%d%H%M%S)-rc"
          gh release create "$VERSION" ./artifact/release-build.zip \
            --prerelease \
            --title "Prerelease $VERSION" \
            --notes "Automated prerelease from CI"
